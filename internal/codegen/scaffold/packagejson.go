package scaffold

import (
	"fmt"
	"strings"

	"github.com/barun-bash/human/internal/ir"
)

// generateRootPackageJSON produces a root package.json with npm workspaces
// that orchestrate both the node backend and react frontend.
// This overwrites the Docker generator's simpler package.json.
func generateRootPackageJSON(app *ir.Application) string {
	var b strings.Builder
	name := appNameLower(app)

	b.WriteString("{\n")
	fmt.Fprintf(&b, "  \"name\": \"%s\",\n", name)
	b.WriteString("  \"version\": \"0.1.0\",\n")
	b.WriteString("  \"private\": true,\n")
	fmt.Fprintf(&b, "  \"description\": \"%s â€” generated by Human compiler\",\n", app.Name)
	b.WriteString("  \"workspaces\": [\n")
	b.WriteString("    \"node\",\n")
	b.WriteString("    \"react\"\n")
	b.WriteString("  ],\n")
	b.WriteString("  \"scripts\": {\n")
	b.WriteString("    \"dev\": \"concurrently \\\"npm run dev --workspace=node\\\" \\\"npm run dev --workspace=react\\\"\",\n")
	b.WriteString("    \"start\": \"concurrently \\\"npm run start --workspace=node\\\" \\\"npm run start --workspace=react\\\"\",\n")
	b.WriteString("    \"build\": \"npm run build --workspace=node && npm run build --workspace=react\",\n")
	b.WriteString("    \"test\": \"npm run test --workspace=node\",\n")
	b.WriteString("    \"db:migrate\": \"cd node && npx prisma migrate deploy\",\n")
	b.WriteString("    \"db:seed\": \"cd node && npx prisma db seed\",\n")
	b.WriteString("    \"db:studio\": \"cd node && npx prisma studio\",\n")
	b.WriteString("    \"docker:dev\": \"docker compose up --build\",\n")
	b.WriteString("    \"docker:start\": \"docker compose up -d\",\n")
	b.WriteString("    \"docker:stop\": \"docker compose down\"\n")
	b.WriteString("  },\n")
	b.WriteString("  \"devDependencies\": {\n")
	b.WriteString("    \"concurrently\": \"^9.0.0\"\n")
	b.WriteString("  }\n")
	b.WriteString("}\n")

	return b.String()
}

// generateNodePackageJSON produces node/package.json with Express, Prisma,
// and all backend dependencies.
func generateNodePackageJSON(app *ir.Application) string {
	var b strings.Builder
	name := appNameLower(app)

	b.WriteString("{\n")
	fmt.Fprintf(&b, "  \"name\": \"%s-backend\",\n", name)
	b.WriteString("  \"version\": \"0.1.0\",\n")
	b.WriteString("  \"private\": true,\n")
	b.WriteString("  \"scripts\": {\n")
	b.WriteString("    \"start\": \"node dist/server.js\",\n")
	b.WriteString("    \"dev\": \"ts-node src/server.ts\",\n")
	b.WriteString("    \"build\": \"tsc\",\n")
	b.WriteString("    \"test\": \"jest\"\n")
	b.WriteString("  },\n")
	b.WriteString("  \"dependencies\": {\n")
	b.WriteString("    \"@prisma/client\": \"^6.0.0\",\n")
	b.WriteString("    \"bcryptjs\": \"^2.4.3\",\n")
	b.WriteString("    \"cors\": \"^2.8.5\",\n")
	b.WriteString("    \"express\": \"^4.21.0\",\n")
	b.WriteString("    \"jsonwebtoken\": \"^9.0.0\"\n")
	b.WriteString("  },\n")
	b.WriteString("  \"devDependencies\": {\n")
	b.WriteString("    \"@types/bcryptjs\": \"^2.4.6\",\n")
	b.WriteString("    \"@types/cors\": \"^2.8.17\",\n")
	b.WriteString("    \"@types/express\": \"^5.0.0\",\n")
	b.WriteString("    \"@types/jest\": \"^29.5.0\",\n")
	b.WriteString("    \"@types/jsonwebtoken\": \"^9.0.7\",\n")
	b.WriteString("    \"@types/supertest\": \"^6.0.0\",\n")
	b.WriteString("    \"jest\": \"^29.7.0\",\n")
	b.WriteString("    \"prisma\": \"^6.0.0\",\n")
	b.WriteString("    \"supertest\": \"^7.0.0\",\n")
	b.WriteString("    \"ts-jest\": \"^29.2.0\",\n")
	b.WriteString("    \"ts-node\": \"^10.9.0\",\n")
	b.WriteString("    \"typescript\": \"^5.7.0\"\n")
	b.WriteString("  }\n")
	b.WriteString("}\n")

	return b.String()
}

// generateReactPackageJSON produces react/package.json with React, Vite,
// and frontend dependencies.
func generateReactPackageJSON(app *ir.Application) string {
	var b strings.Builder
	name := appNameLower(app)

	b.WriteString("{\n")
	fmt.Fprintf(&b, "  \"name\": \"%s-frontend\",\n", name)
	b.WriteString("  \"version\": \"0.1.0\",\n")
	b.WriteString("  \"private\": true,\n")
	b.WriteString("  \"type\": \"module\",\n")
	b.WriteString("  \"scripts\": {\n")
	b.WriteString("    \"dev\": \"vite\",\n")
	b.WriteString("    \"build\": \"tsc && vite build\",\n")
	b.WriteString("    \"preview\": \"vite preview\",\n")
	b.WriteString("    \"start\": \"vite preview\"\n")
	b.WriteString("  },\n")
	b.WriteString("  \"dependencies\": {\n")
	b.WriteString("    \"react\": \"^19.0.0\",\n")
	b.WriteString("    \"react-dom\": \"^19.0.0\",\n")
	b.WriteString("    \"react-router-dom\": \"^7.0.0\"\n")
	b.WriteString("  },\n")
	b.WriteString("  \"devDependencies\": {\n")
	b.WriteString("    \"@types/react\": \"^19.0.0\",\n")
	b.WriteString("    \"@types/react-dom\": \"^19.0.0\",\n")
	b.WriteString("    \"@vitejs/plugin-react\": \"^4.3.0\",\n")
	b.WriteString("    \"autoprefixer\": \"^10.4.0\",\n")
	b.WriteString("    \"postcss\": \"^8.4.0\",\n")
	b.WriteString("    \"tailwindcss\": \"^3.4.0\",\n")
	b.WriteString("    \"typescript\": \"^5.7.0\",\n")
	b.WriteString("    \"vite\": \"^6.0.0\"\n")
	b.WriteString("  }\n")
	b.WriteString("}\n")

	return b.String()
}
