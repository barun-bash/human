# Generated by Human compiler â€” do not edit

FROM node:20-alpine AS builder

WORKDIR /app

# Install dependencies
COPY package.json package-lock.json* ./
RUN npm install

# Generate Prisma client
COPY prisma ./prisma
RUN npx prisma generate

# Copy source and build
COPY . .
RUN npm run build

# Production
FROM node:20-alpine

WORKDIR /app

COPY --from=builder /app/package.json ./
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/prisma ./prisma

# Generate start script
RUN echo '#!/bin/sh' > start.sh && \
    echo 'set -e' >> start.sh && \
    echo 'echo "Syncing database schema..."' >> start.sh && \
    echo 'npx prisma db push --accept-data-loss' >> start.sh && \
    echo 'echo "Starting application..."' >> start.sh && \
    echo 'node dist/server.js' >> start.sh && \
    chmod +x start.sh

EXPOSE 3000

CMD ["./start.sh"]
